<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="fontawesome/css/all.min.css" />
    <title>Web Gabut</title>
  </head>
  <body>
    <!-- Navbar -->
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-dark shadow-lg fixed-top"
    >
      <div class="container">
        <a class="navbar-brand" href="#"> Web Gabut</a>
      </div>
    </nav>
    <!-- Akhir Navbar -->

    <div
      class="container-fluid pt-5 pb-5"
      style="
        background: url(https://media.istockphoto.com/id/1283506462/photo/white-desk-office-with-laptop-smartphone-and-other-work-supplies-with-cup-of-coffee-top-view.jpg?b=1&s=170667a&w=0&k=20&c=Urxk_SoXDdV7ietMtbeOGRtZO54p7ZlbMDLFuJuYtr8=)
          no-repeat center;
        padding-top: 20%;
        padding-bottom: 20%;
        background-size: cover;
      "
    >
      <div class="container pb-5 pt-5">
        <div class="row">
          <h4 class="text-center text-success pb-3">
            <strong>
              Yuk Tulis Sesuatu, Terserah apapun itu. Akan di tampilkan di bawah
              secara Anonim
            </strong>
          </h4>
          <div class="col-md-2"></div>
          <div class="col-md-8">
            <!-- Alert -->
            <div
              class="alert alert-success alert-dismissible fade show d-none my-alert"
              role="alert"
            >
              <strong>Terima Kasih!</strong> Pesan Anda Telah Dikirim
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
            <!-- Akhir Alert -->
            <form name="form-gabut">
              <div class="form-floating pb-3">
                <textarea
                  class="form-control"
                  name="pesan"
                  placeholder="Leave a comment here"
                  id="floatingTextarea2"
                  style="height: 200px"
                  required
                ></textarea>
                <label for="floatingTextarea2">Sampaikan Sesuatu Di Sini</label>
              </div>
              <button type="submit" class="btn btn-primary btn-lg btn-kirim">
                Kirim
              </button>
              <button
                class="btn btn-primary btn-lg btn-loading d-none"
                type="button"
                disabled
              >
                <span
                  class="spinner-border spinner-border-sm"
                  role="status"
                  aria-hidden="true"
                ></span>
                Loading...
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Section untuk menampilkan pesan -->
    <div class="row justify-content-center align-items-center">
      <div class="col-md-8">
        <div class="container pt-4 pb-5">
          <h3 class="text-center mb-4">Pesan Anonim</h3>

          <div class="row mb-2">
            <div class="col-md-6">
              <div id="info-count" class="small text-muted"></div>
            </div>
            <div class="col-md-6 text-end">
              <label class="me-2 small">Pesan per halaman:</label>
              <select
                id="page-size-select"
                class="form-select d-inline-block"
                style="width: auto"
              >
                <option value="5" selected>5</option>
                <option value="10">10</option>
                <option value="20">20</option>
              </select>
            </div>
          </div>

          <div id="list-pesan">
            <!-- Pesan dari Spreadsheet akan tampil di sini sebagai list vertikal -->
          </div>

          <nav aria-label="Pagination">
            <ul
              class="pagination justify-content-center mt-3"
              id="pagination"
            ></ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="container pt-4 pb-3">
      <div class="row">
        <div class="col-md-4"></div>
        <div class="col-md-4 text-center">
          <h4 class="contact">Contact Me</h4>
          <a href="#"><i class="fa-brands fa-whatsapp fa-2x m-2"></i></a>
          <a href="#"><i class="fa-brands fa-facebook fa-2x m-2"></i></a>
          <a href="#"><i class="fa-brands fa-instagram fa-2x m-2"></i></a>
        </div>
      </div>
    </div>

    <div class="container-fluid text-center pt-5 pb-5">
      All Rights Reserved Ulis Sayang &copy; 2022
    </div>

    <script>
      // Hanya 1 link untuk GET & POST
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbx12WYRFkooHF1xxPnLJjgJqHkC1DwxnG1JV17aWUhPQ-Roj6-abBtYsS1dO4V32LC36Q/exec";

      const form = document.forms["form-gabut"];
      const btnKirim = document.querySelector(".btn-kirim");
      const btnLoading = document.querySelector(".btn-loading");
      const myAlert = document.querySelector(".my-alert");
      const listPesan = document.getElementById("list-pesan");
      const paginationEl = document.getElementById("pagination");
      const infoCount = document.getElementById("info-count");
      const pageSizeSelect = document.getElementById("page-size-select");

      // state
      let currentPage = 1;
      let pageSize = parseInt(pageSizeSelect.value, 10); // bisa diubah dari select
      let messages = []; // akan menampung array pesan

      // --- Keamanan: escape HTML untuk mencegah XSS ---
      function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // ubah newline menjadi <br> setelah di-escape
      function nl2brEscaped(text) {
        return escapeHtml(text).replace(/\r?\n/g, "<br>");
      }

      // Submit form (kirim ke Google Apps Script)
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        btnLoading.classList.toggle("d-none");
        btnKirim.classList.toggle("d-none");

        fetch(scriptURL, { method: "POST", body: new FormData(form) })
          .then((response) => {
            // Handling response: tetap refresh daftar pesan
            btnLoading.classList.toggle("d-none");
            btnKirim.classList.toggle("d-none");
            myAlert.classList.remove("d-none");
            form.reset();
            loadPesan();
          })
          .catch((error) => {
            console.error("Error saat submit:", error);
            btnLoading.classList.toggle("d-none");
            btnKirim.classList.toggle("d-none");
            alert("Gagal mengirim pesan. Cek console untuk detail.");
          });
      });

      // Render pagination dengan tombol Prev / Next + nomor halaman
      function renderPagination() {
        const totalPages = Math.max(1, Math.ceil(messages.length / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        let html = "";

        html += `<li class="page-item ${currentPage === 1 ? "disabled" : ""}">
                  <a class="page-link" href="#" data-action="prev" aria-label="Previous">Previous</a>
                </li>`;

        const delta = 2;
        let start = Math.max(1, currentPage - delta);
        let end = Math.min(totalPages, currentPage + delta);

        if (currentPage <= delta) {
          end = Math.min(totalPages, end + (delta - currentPage + 1));
        }
        if (currentPage + delta > totalPages) {
          start = Math.max(1, start - (currentPage + delta - totalPages));
        }

        for (let i = start; i <= end; i++) {
          html += `<li class="page-item ${i === currentPage ? "active" : ""}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                  </li>`;
        }

        html += `<li class="page-item ${
          currentPage === totalPages ? "disabled" : ""
        }">
                  <a class="page-link" href="#" data-action="next" aria-label="Next">Next</a>
                </li>`;

        paginationEl.innerHTML = html;

        paginationEl.querySelectorAll("a").forEach((link) => {
          link.addEventListener("click", (ev) => {
            ev.preventDefault();
            const action = link.getAttribute("data-action");
            const page = parseInt(link.getAttribute("data-page"), 10);

            if (action === "prev" && currentPage > 1) {
              currentPage--;
            } else if (action === "next" && currentPage < totalPages) {
              currentPage++;
            } else if (!isNaN(page)) {
              currentPage = page;
            }
            displayMessages();
            renderPagination();
            listPesan.scrollIntoView({ behavior: "smooth" });
          });
        });
      }

      // Build DOM cards (aman dari XSS karena menggunakan textContent)
      function displayMessages() {
        const total = messages.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;

        const startIdx = (currentPage - 1) * pageSize;
        const endIdx = Math.min(startIdx + pageSize, total);
        const pageMessages = messages.slice(startIdx, endIdx);

        if (total === 0) {
          infoCount.textContent = "Belum ada pesan.";
          listPesan.innerHTML =
            '<p class="text-center text-muted">Belum ada pesan...</p>';
          paginationEl.innerHTML = "";
          return;
        } else {
          infoCount.textContent = `Menampilkan ${
            startIdx + 1
          } - ${endIdx} dari ${total} pesan. Halaman ${currentPage} dari ${totalPages}.`;
        }

        listPesan.innerHTML = "";

        pageMessages.forEach((item) => {
          const pesanRaw = item.pesan ? item.pesan : "(Pesan kosong)";
          const waktuRaw = item.timestamp ? new Date(item.timestamp) : null;

          const card = document.createElement("div");
          card.className = "card shadow-sm mb-3";

          const cardBody = document.createElement("div");
          cardBody.className = "card-body d-flex align-items-start";

          // Icon user
          const icon = document.createElement("i");
          icon.className = "fa fa-user fa-2x text-secondary me-3 mt-1";

          // pesan
          const p = document.createElement("p");
          p.className = "card-text mb-1";
          p.innerHTML = nl2brEscaped(pesanRaw);

          const small = document.createElement("small");
          small.className = "text-muted";
          small.textContent = waktuRaw ? waktuRaw.toLocaleString() : "-";

          const pesanWrapper = document.createElement("div");
          pesanWrapper.appendChild(p);
          pesanWrapper.appendChild(small);

          cardBody.appendChild(icon);
          cardBody.appendChild(pesanWrapper);
          card.appendChild(cardBody);
          listPesan.appendChild(card);
        });
      }

      // Ambil data dari script (GET)
      function loadPesan() {
        fetch(scriptURL)
          .then((res) => {
            if (!res.ok) throw new Error("Network response was not ok");
            return res.json();
          })
          .then((json) => {
            if (json.result === "success" && Array.isArray(json.data)) {
              messages = json.data.slice().reverse();
              currentPage = 1;
              displayMessages();
              renderPagination();
            } else {
              console.warn(
                "Response tidak sesuai format yang diharapkan:",
                json
              );
              messages = [];
              listPesan.innerHTML =
                '<p class="text-center text-muted">Belum ada pesan...</p>';
              paginationEl.innerHTML = "";
              infoCount.textContent = "";
            }
          })
          .catch((err) => {
            console.error("Gagal ambil data:", err);
            listPesan.innerHTML =
              '<p class="text-center text-danger">Error mengambil data! Cek console.</p>';
            paginationEl.innerHTML = "";
            infoCount.textContent = "";
          });
      }

      pageSizeSelect.addEventListener("change", () => {
        pageSize = parseInt(pageSizeSelect.value, 10) || 5;
        currentPage = 1;
        displayMessages();
        renderPagination();
      });

      loadPesan();
    </script>

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.3/gsap.min.js"></script>

    <script>
      gsap.from(".text-success", {
        duration: 1.5,
        y: "100%",
        opacity: 0,
        ease: "bounce.out",
      });
      gsap.from(".form-floating", {
        duration: 2.5,
        delay: 1,
        ease: "back.out(1.7)",
        y: 100,
        opacity: 0,
      });
      gsap.from(".btn-kirim", {
        duration: 2.5,
        delay: 1,
        ease: "back.out(1.7)",
        x: -50,
        opacity: 0,
      });
      gsap.from(".navbar", {
        duration: 1.5,
        y: "-100%",
        opacity: 0,
        ease: "bounce.out",
      });
      gsap.from(".contact", {
        duration: 4,
        delay: 2,
        x: -50,
        opacity: 0,
        ease: "elastic.out(1, 0.3)",
      });
      gsap.from(".fa-whatsapp", {
        duration: 4,
        delay: 2.5,
        y: 30,
        opacity: 0,
        ease: "elastic.out(1, 0.3)",
      });
      gsap.from(".fa-facebook", {
        duration: 4,
        delay: 2.7,
        y: 30,
        opacity: 0,
        ease: "elastic.out(1, 0.3)",
      });
      gsap.from(".fa-instagram", {
        duration: 4,
        delay: 3,
        y: 30,
        opacity: 0,
        ease: "elastic.out(1, 0.3)",
      });
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
