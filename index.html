<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Web Gabut</title>

    <!-- Bootstrap & Icons via CDN (stabil buat GitHub Pages) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />

    <style>
      body {
        background: #f7f8fa;
      }
      .card {
        border: none;
        border-radius: 1rem;
      }
      .navbar-brand {
        font-weight: 700;
      }
      .hero {
        background: url(https://images.unsplash.com/photo-1517694712202-14dd9538aa97?q=80&w=1200&auto=format&fit=crop)
          center/cover no-repeat;
      }
      .message-empty {
        color: #6c757d;
      }
      .footer {
        background: #111;
        color: #bbb;
      }
      .danger-note {
        font-size: 0.9rem;
      }
      .blur {
        filter: blur(2px);
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-dark shadow-lg fixed-top"
    >
      <div class="container">
        <a class="navbar-brand" href="#">Web Gabut</a>
      </div>
    </nav>

    <!-- Hero + Form -->
    <section class="hero container-fluid pt-5 pb-5" style="padding-top: 7rem">
      <div class="container pb-5 pt-5">
        <div class="row">
          <h4 class="text-center text-success pb-3 text-success-animated">
            <strong>
              Yuk tulis sesuatu buat aku â€” saran, kritik, atau curhat juga boleh
              ðŸ˜‰
            </strong>
          </h4>
          <div class="col-md-2"></div>
          <div class="col-md-8">
            <!-- Alert -->
            <div
              class="alert alert-success alert-dismissible fade show d-none my-alert"
              role="alert"
            >
              <strong>Terima kasih!</strong> Pesan Anda telah dikirim.
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>

            <!-- Form -->
            <form name="form-gabut" class="card shadow p-3">
              <div class="form-floating pb-3 form-floating-animated">
                <textarea
                  class="form-control"
                  name="pesan"
                  placeholder="Tulis sesuatu di siniâ€¦"
                  id="floatingTextarea2"
                  style="height: 180px"
                  required
                ></textarea>
                <label for="floatingTextarea2">Sampaikan sesuatu di sini</label>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg btn-kirim">
                  Kirim
                </button>
                <button
                  class="btn btn-primary btn-lg btn-loading d-none"
                  type="button"
                  disabled
                >
                  <span
                    class="spinner-border spinner-border-sm"
                    role="status"
                    aria-hidden="true"
                  ></span>
                  Loading...
                </button>
              </div>
              <p class="mt-2 mb-0 text-muted danger-note">
                * Mohon tidak mengirim tautan berbahaya atau data pribadi
                sensitif.
              </p>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- List Pesan -->
    <section class="container pt-4 pb-5">
      <h5 class="mb-3">Pesan Terbaru</h5>
      <div class="row g-3 pesan-container">
        <!-- pesan akan ditampilkan di sini -->
      </div>
      <div class="text-center mt-3">
        <button id="reloadBtn" class="btn btn-outline-secondary btn-sm">
          Muat Ulang
        </button>
      </div>
    </section>

    <!-- Contact -->
    <section class="container pb-4">
      <div class="row">
        <div class="col-md-4"></div>
        <div class="col-md-4 text-center">
          <h4 class="contact">Contact Me</h4>
          <div class="d-flex justify-content-center">
            <a
              class="text-decoration-none"
              href="https://wa.me/085280357433"
              aria-label="WhatsApp"
            >
              <i class="fa-brands fa-whatsapp fa-2x m-2"></i>
            </a>
            <a
              class="text-decoration-none"
              href="https://web.facebook.com/profile.php?id=100008691764112"
              aria-label="Facebook"
            >
              <i class="fa-brands fa-facebook fa-2x m-2"></i>
            </a>
            <a
              class="text-decoration-none"
              href="https://instagram.com/ulis_leu_sari?igshid=YmMyMTA2M2Y="
              aria-label="Instagram"
            >
              <i class="fa-brands fa-instagram fa-2x m-2"></i>
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="container-fluid text-center pt-5 pb-5 footer">
      All Rights Reserved Ulis Sayang &copy; 2022
    </footer>

    <!-- ====== APP SCRIPT INTEGRATION ====== -->
    <script>
      // Ganti hanya jika kamu deploy ulang Web App dan URL berubah
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbyuoR-Xyogiyz7VMnb7882tnEcDjSJ3rtLePq3R5dQhULJAUiub-SAOdoWega0HncfSzA/exec";

      const form = document.forms["form-gabut"];
      const btnKirim = document.querySelector(".btn-kirim");
      const btnLoading = document.querySelector(".btn-loading");
      const myAlert = document.querySelector(".my-alert");
      const pesanContainer = document.querySelector(".pesan-container");
      const reloadBtn = document.getElementById("reloadBtn");

      // Helper: buat kartu pesan (aman dari XSS)
      function createMessageCard(item) {
        const col = document.createElement("div");
        col.className = "col-md-6";

        const card = document.createElement("div");
        card.className = "card shadow-sm p-3";

        const ts = document.createElement("p");
        ts.className = "mb-1 text-muted";
        const small = document.createElement("small");
        small.textContent = item.timestamp
          ? new Date(item.timestamp).toLocaleString("id-ID")
          : "";
        ts.appendChild(small);

        const msg = document.createElement("p");
        msg.textContent = item.pesan || "";

        card.appendChild(ts);
        card.appendChild(msg);
        col.appendChild(card);
        return col;
      }

      // Kirim pesan (POST)
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        btnLoading.classList.remove("d-none");
        btnKirim.classList.add("d-none");

        try {
          const res = await fetch(scriptURL, {
            method: "POST",
            body: new FormData(form),
          });

          // Apps Script Web App balas JSON; res.ok biasanya true
          if (!res.ok) throw new Error("Response status: " + res.status);

          // reset + alert
          form.reset();
          myAlert.classList.remove("d-none");

          // reload daftar pesan
          await loadPesan();
        } catch (err) {
          console.error("Gagal kirim:", err);
          alert("Gagal kirim pesan. Cek koneksi atau izin Web App.");
        } finally {
          btnLoading.classList.add("d-none");
          btnKirim.classList.remove("d-none");
        }
      });

      // Ambil pesan (GET)
      async function loadPesan() {
        // tambahkan query ?t= untuk hindari cache
        const url = scriptURL + "?t=" + Date.now();
        try {
          const res = await fetch(url, { method: "GET" });
          const json = await res.json(); // pastikan doGet mengembalikan JSON

          pesanContainer.innerHTML = "";

          if (
            json.result === "success" &&
            Array.isArray(json.data) &&
            json.data.length > 0
          ) {
            // tampilkan terbaru di atas
            json.data
              .slice()
              .reverse()
              .forEach((item) => {
                pesanContainer.appendChild(createMessageCard(item));
              });
          } else if (
            json.result === "empty" ||
            (json.result === "success" && json.data.length === 0)
          ) {
            pesanContainer.innerHTML =
              '<p class="message-empty">Belum ada pesan.</p>';
          } else if (json.result === "error") {
            console.error("Error dari server:", json.message);
            pesanContainer.innerHTML =
              '<p class="text-danger">Gagal memuat pesan (server).</p>';
          } else {
            // Jika struktur tak terduga
            console.warn("Struktur tak terduga:", json);
            pesanContainer.innerHTML =
              '<p class="text-danger">Gagal memuat pesan (format tidak dikenali).</p>';
          }
        } catch (err) {
          console.error("Gagal ambil data:", err);
          pesanContainer.innerHTML =
            '<p class="text-danger">Gagal memuat pesan (jaringan/izin).</p>';
        }
      }

      // Tombol reload
      reloadBtn.addEventListener("click", loadPesan);

      // Load awal
      loadPesan();
    </script>

    <!-- GSAP Animations (opsional) -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"
      crossorigin="anonymous"
    ></script>
    <script>
      gsap.from(".text-success-animated", {
        duration: 1.2,
        y: 30,
        opacity: 0,
        ease: "power3.out",
      });
      gsap.from(".form-floating-animated", {
        duration: 1.2,
        delay: 0.3,
        y: 24,
        opacity: 0,
        ease: "power3.out",
      });
      gsap.from(".navbar", {
        duration: 0.9,
        y: -50,
        opacity: 0,
        ease: "power2.out",
      });
      gsap.from(".contact", {
        duration: 1,
        delay: 0.4,
        opacity: 0,
        ease: "power2.out",
      });
    </script>

    <!-- Bootstrap JS bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
